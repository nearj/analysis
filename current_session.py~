# coding: utf-8

from mpvr.datamanager.threedi import ThreeDI as dm
from mpvr.utils.process import *

dm = dm.from_config()
holder = {}
for scenario in dm.get_scenarios():
    dm.set_scenario(scenario)
    mpe = dm._load_processed_data('mpe')[1]
    incidence = dm._load_incidence()
    holder[scenario] = correlation(mpe, incidence)
dm._save_correaltion_as_table(holder, 'mpe')
dm.set_scenario('3DI_01')
mpe = dm._load_processed_data('mpe')[1]
import pandas as pd
incidence = pd.read_csv('./data/raw/incidence/3DI_total.csv').values
incidence
incidence = pd.read_csv('./data/raw/incidence/3DI_total.csv').values[:,1]
incidence = pd.read_csv('./data/raw/incidence/3DI_total.csv').values[:,1]
incidence
correlation(mpe, incidence)
for scenario in dm.get_scenarios():
    dm.set_scenario(scenario)
    mpe = dm._load_processed_data('mpe')[1]
    incidence = pd.read_csv('./data/raw/incidence/3DI_total.csv').values[:,1]
    print(correlation(mpe, incidence))
    
dm.set_scenario('3DI_01')
time, mpe = dm._load_processed_data('mpe')
time
np.where(time > 30)
time[90]
tmp = np.zeros(len(time[90:]))
for scenario in dm.get_scenarios():
    dm.set_scenario(scenario)
    tmp += dm._load_processed_data('mpe')[1][90:]
    
    
incidence = pd.read_csv('./data/raw/incidence/3DI_total.csv').values[:,1]
incidence
len(incidence
)
len(tmp)
incidence = incidence[90:]
len(incidence)
correlation(tmp, incidence)
tmp /= 30
correlation(tmp, incidence)
tmp
tmp *= 30
tmp
mpe30to104 = tmp
time
incidence
len(incidence
)
len(mpe30to104)
np.max(mpe30to104)
np.where(mpe30to104 >= np.max(mpe30to104)*0.75)
np.max(mpe30to104)
mp.max(mpe30to104)*0.75
np.max(mpe30to104)*0.75
np.where(mpe30to104 >= 0)
mpe30to104[np.where(mpe30to104 >= 0)[0]]
mpe30to104[np.where(mpe30to104 >= 0)[0]] / 30
np.percentile(mpe30to104, 75)
np.percentile(mpe30to104, 25)
mpe30to104 /= 30
np.percentile(mpe30to104, 25)
np.percentile(mpe30to104, 10)
np.percentile(mpe30to104, 4)
np.percentile(mpe30to104, 3)
np.percentile(mpe30to104, 1)
np.percentile(mpe30to104, [75, 50, 25])
np.percentile(mpe30to104, [90, 50, 25])
np.percentile(mpe30to104, 75)
tmp
len(tmp)
import matplotlib.pyplot as plt
plt.plot(mpe)
time
len(time)
plt.plot(time, mpe)
dm._scenario
def save_fig(scenario, data, incidence, time):
    from matplotlib import pyplot as plt
    from matplotlib.collections import LineCollection
    from matplotlib.colors import ListedColormap, BoundaryNorm
    directory = './data/processed/result/3di_2018/graph/MPentropy/{:s}.png'.format(scenario)
    ylim = [-250000, 250000]
    plt.close()

    x = []
    y = []
    for i in range(len(data)-1):
        x.append(time[i])
        y.append(data[i])
        if data[i] * data[i + 1] <= 0:
            x.append((time[i] + time[i+1]) / 2)
            if data[i] > 0:
                y.append(-0.0000000001)
            else:
                y.append(0.000000001)
    i += 1
    x.append(time[i])
    y.append(data[i])

    points = np.array([x, y]).T.reshape(-1,1,2)
    segments = np.concatenate([points[:-1], points[1:]], axis=1)

    fig, axes = plt.subplots(2, 1, sharex=True)
    fig.set_size_inches(18, 6)

    cmap = ListedColormap(['C1', 'C0'])
    norm = BoundaryNorm([-10000000, 0, 10000000], cmap.N)

    lc = LineCollection(segments, cmap=cmap, norm=norm)
    lc.set_array(np.array([1 if t > 0 else -1 for t in y]))
    axes[0].add_collection(lc)
    axes[1].bar(time, incidence, width=0.1)

    axes[0].set_xlabel('time', fontsize = 18)
    axes[0].set_ylabel('MP Entropy', fontsize = 18)
    axes[0].set_xlim(x[0], x[-1])
    axes[0].set_ylim(ylim)
    axes[0].set_xticks(np.arange(int(time[0]), int(time[-1])+1, 2))
    axes[0].grid(axis='x')

    axes[1].set_ylabel('Incidence', fontsize = 18)
    axes[1].set_ylim([0,3])
    axes[1].set_xticks(np.arange(int(time[0]), int(time[-1])+1, 2))
    axes[1].grid(axis='x')

    plt.tight_layout()
    plt.savefig(directory)
len(incidence)
incidence = pd.read_csv('./data/raw/incidence/3DI_total.csv').values[:,1]
save_fig('3DI_summed', mpe, incidence, time)
def save_fig(scenario, data, incidence, time):
    from matplotlib import pyplot as plt
    from matplotlib.collections import LineCollection
    from matplotlib.colors import ListedColormap, BoundaryNorm
    directory = './data/processed/result/3di_2018/graph/MPentropy/{:s}.png'.format(scenario)
    ylim = [-250000, 250000]
    plt.close()

    x = []
    y = []
    for i in range(len(data)-1):
        x.append(time[i])
        y.append(data[i])
        if data[i] * data[i + 1] <= 0:
            x.append((time[i] + time[i+1]) / 2)
            if data[i] > 0:
                y.append(-0.0000000001)
            else:
                y.append(0.000000001)
    i += 1
    x.append(time[i])
    y.append(data[i])

    points = np.array([x, y]).T.reshape(-1,1,2)
    segments = np.concatenate([points[:-1], points[1:]], axis=1)

    fig, axes = plt.subplots(2, 1, sharex=True)
    fig.set_size_inches(18, 6)

    cmap = ListedColormap(['C1', 'C0'])
    norm = BoundaryNorm([-10000000, 0, 10000000], cmap.N)

    lc = LineCollection(segments, cmap=cmap, norm=norm)
    lc.set_array(np.array([1 if t > 0 else -1 for t in y]))
    axes[0].add_collection(lc)
    axes[1].bar(time, incidence, width=0.1)

    axes[0].set_xlabel('time', fontsize = 18)
    axes[0].set_ylabel('MP Entropy', fontsize = 18)
    axes[0].set_xlim(x[0], x[-1])
    axes[0].set_ylim(ylim)
    axes[0].set_xticks(np.arange(int(time[0]), int(time[-1])+1, 2))
    axes[0].grid(axis='x')

    axes[1].set_ylabel('Incidence', fontsize = 18)
    axes[1].set_xticks(np.arange(int(time[0]), int(time[-1])+1, 2))
    axes[1].grid(axis='x')

    plt.tight_layout()
    plt.savefig(directory)
save_fig('3DI_summed', mpe, incidence, time)
np.quantile(mpe30to104, 75)
np.quantile(mpe30to104, .75)
np.where(np.quantile(mpe30to104, .75))
np.where(mpe30to104 >= np.quantile(mpe30to104, .75))
mpe30to104_q1 = mpe30to104[np.where(mpe30to104 >= np.quantile(mpe30to104, .75))[0]]
incidence30to104_q1 = incidence[np.where(mpe30to104 >= np.quantile(mpe30to104, .75))[0]]
correlation(mpe30to104_q1, incidence30to104_q1)
plt.scatter(time[np.where(mpe30to104 >= np.quantile(mpe30to104, .75))[0]], mpe30to104_q1)
plt.show
plt.show()
plt.clear()
plt.clf()
plt.scatter(time[np.where(mpe30to104 >= np.quantile(mpe30to104, .75))[0]], mpe30to104_q1)
plt.show()
np.where(mpe30to104 >= np.quantile(mpe30to104, .75))[0]
time[np.where(mpe30to104 >= np.quantile(mpe30to104, .75))[0]]
time[90:][np.where(mpe30to104 >= np.quantile(mpe30to104, .75))[0]]
plt.scatter(time[90:][np.where(mpe30to104 >= np.quantile(mpe30to104, .75))[0]], mpe30to104_q1)
plt.clf()
plt.scatter(time[90:][np.where(mpe30to104 >= np.quantile(mpe30to104, .75))[0]], mpe30to104_q1)
plt.plot()
plt.show()
plt.plot(time[90:][np.where(mpe30to104 >= np.quantile(mpe30to104, .75))[0]], mpe30to104_q1)
get_ipython().magic('save current_session ~0/')
